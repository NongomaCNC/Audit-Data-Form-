<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Field Data Capture</title>

    <link rel="manifest" href="manifest.json">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>

    <style>
        /* ---------- BASIC LAYOUT ---------- */
        body {
            font-family: Arial, Helvetica, sans-serif;
            margin: 0;
            padding: 1rem;
            background: #f2f2f2;
            color: #333;
            -webkit-tap-highlight-color: transparent; /* Remove tap highlight on mobile */
        }
        h1 {
            text-align: center;
            color: #333;
            margin-top: 0.5rem;
            margin-bottom: 1.5rem;
        }

        form {
            background: #fff;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            display: grid;
            gap: 1rem;
            grid-template-columns: 1fr;
            max-width: 900px;
            margin: auto;
            margin-bottom: 2rem; /* Add space below form */
        }
        /* Adjust for smaller mobile screens before 600px breakpoint */
        @media (max-width: 599px) {
            form {
                padding: 0.8rem;
                gap: 0.8rem;
            }
            .field label {
                font-size: 0.95rem;
            }
            input, select, textarea {
                font-size: 0.9rem;
                padding: 0.4rem;
            }
            button {
                padding: 0.6rem 0.8rem;
                font-size: 0.9rem;
            }
        }
        @media (min-width: 600px) {
            form {
                grid-template-columns: 1fr 1fr;
            }
        }

        /* ---------- FORM ELEMENTS ---------- */
        .field {
            display: flex;
            flex-direction: column;
        }
        label {
            margin-bottom: 0.3rem;
            font-weight: bold;
        }
        input, select, textarea {
            padding: 0.5rem;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 1rem;
            width: 100%; /* Ensure inputs take full width */
            box-sizing: border-box; /* Include padding and border in the element's total width and height */
        }
        textarea {
            min-height: 50px;
            resize: vertical;
        }

        /* Style for readonly GPS inputs */
        input[readonly] {
            background-color: #e9e9e9;
            cursor: not-allowed;
        }

        /* ---------- BUTTONS ---------- */
        .actions {
            grid-column: 1 / -1;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            justify-content: space-between;
            margin-top: 1rem;
        }
        button {
            flex: 1 1 auto; /* Allow buttons to grow and shrink */
            min-width: 120px; /* Minimum width for buttons */
            border: none;
            border-radius: 5px;
            color: #fff;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        button:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        button:active {
            transform: translateY(0);
            box-shadow: none;
        }

        #gpsBtn { background: #28a745; } /* Green */
        #viewDataBtn { background: #17a2b8; } /* Teal */
        #pdfBtn { background: #6f42c1; } /* Purple */
        #exportBtn { background: #ffc107; color: #000; } /* Amber/Yellow */
        #submitBtn { background: #007bff; } /* Blue */
        #syncBtn { background: #6c757d; } /* Grey */
        #clearDataBtn { background: #dc3545; } /* Red */
        #cancelEditBtn { background: #fd7e14; } /* Orange */

        /* Style for edit buttons in the data table */
        .edit-btn {
            padding: 4px 10px;
            font-size: 0.8rem;
            background: #ffc107;
            color: #000;
            border-radius: 3px;
            cursor: pointer;
            border: none;
        }


        /* ---------- MESSAGES ---------- */
        #message {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: #fff;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            pointer-events: none; /* Allow clicks to pass through */
            text-align: center;
            white-space: nowrap;
        }
        #message.show {
            opacity: 1;
        }

        /* ---------- SAVED DATA SECTION ---------- */
        #savedDataSection {
            background: #fff;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,.1);
            max-width: 900px;
            margin: auto;
            margin-top: 2rem;
            display: none; /* Hidden by default */
        }
        #savedDataSection.visible {
            display: block;
        }
        #savedDataSection h2 {
            text-align: center;
            color: #333;
            margin-top: 0;
            margin-bottom: 1rem;
        }
        #savedDataTableContainer {
            overflow-x: auto; /* Enable horizontal scrolling for tables on small screens */
            max-width: 100%; /* Ensure container respects parent width */
        }
        #savedDataTable {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
        }
        #savedDataTable th, #savedDataTable td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            white-space: nowrap; /* Prevent text wrapping in table cells */
        }
        #savedDataTable th {
            background-color: #f2f2f2;
            font-weight: bold;
            position: sticky; /* Make headers sticky for horizontal scroll */
            left: 0;
            z-index: 1;
        }
        /* Add a bit of space for the new Edit column header */
        #savedDataTable th:last-child {
            min-width: 60px;
        }
        #savedDataTable tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        #savedDataTable tr:hover {
            background-color: #f1f1f1;
        }
        #savedDataActions {
            text-align: center;
            margin-top: 1rem;
            display: flex;
            justify-content: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        /* ---------- LOGIN OVERLAY STYLES ---------- */
        #loginOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            backdrop-filter: blur(5px);
        }
        #loginBox {
            background: #fff;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            max-width: 90%;
            width: 350px;
        }
        #loginBox h2 {
            margin-top: 0;
        }
        #loginBox input {
            width: 100%;
            padding: 0.75rem;
            margin-top: 1rem;
            margin-bottom: 1rem;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        #loginBox button {
            width: 100%;
            padding: 0.75rem;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        #loginBox button:hover {
            background-color: #0056b3;
        }

    </style>
</head>
<body>

    <div id="loginOverlay">
        <div id="loginBox">
            <h2>Enter Access Code</h2>
            <p>Please enter the code to access the application.</p>
            <input type="password" id="accessCode" placeholder="Access Code" autocomplete="current-password">
            <button type="button" id="loginBtn">Login</button>
            <p id="loginError" style="color: red; display: none; margin-top: 1rem; margin-bottom: 0;">Invalid Code</p>
        </div>
    </div>


    <h1>Field Data Capture</h1>

    <form id="captureForm">
        <input type="hidden" id="editRecordId" name="editRecordId">

        <div class="field"><label for="workorderNo">Workorder No</label><input id="workorderNo" name="workorderNo" type="text" placeholder="Optional"></div>
        <div class="field"><label for="zone">Zone</label><input id="zone" name="zone" type="text" placeholder="e.g., North"></div>
        <div class="field"><label for="sector">Sector</label><input id="sector" name="sector" type="text" placeholder="e.g., A"></div>
        <div class="field"><label for="cnc">CNC</label><input id="cnc" name="cnc" type="text"></div>
        <div class="field"><label for="contractorName">Contractor Name or Source</label><input id="contractorName" name="contractorName" type="text"></div>
        <div class="field"><label for="date">Date</label><input id="date" type="date" name="date" required></div>
        <div class="field"><label for="feederName">Feeder Name</label><input id="feederName" name="feederName" type="text"></div>
        <div class="field"><label for="townshipName">Township Name</label><input id="townshipName" name="townshipName" type="text"></div>
        <div class="field"><label for="transformerNo">Transformer No <span style="color:red">*</span></label><input id="transformerNo" name="transformerNo" type="text" required></div>
        <div class="field"><label for="standNo">Stand No</label><input id="standNo" name="standNo" type="text"></div>
        <div class="field"><label for="installationNo">Installation No</label><input id="installationNo" name="installationNo" type="text"></div>
        <div class="field"><label for="lat">Latitude (DD MM SS.SSS S/N)</label><input id="lat" name="latitude" type="text" readonly></div>
        <div class="field"><label for="lon">Longitude (DD MM SS.SSS E/W)</label><input id="lon" name="longitude" type="text" readonly></div>

        <div class="field"><label for="access">Access</label><select id="access" name="access"><option value="">— Select —</option><option value="Yes">Yes</option><option value="No">No</option></select></div>
        <div class="field"><label for="atHome">At Home</label><select id="atHome" name="atHome"><option value="">— Select —</option><option value="Yes">Yes</option><option value="No">No</option></select></div>
        <div class="field"><label for="connected">Connected</label><select id="connected" name="connected"><option value="">— Select —</option><option value="Yes">Yes</option><option value="No">No</option></select></div>
        <div class="field"><label for="abandoned">Abandoned</label><select id="abandoned" name="abandoned"><option value="">— Select —</option><option value="Yes">Yes</option><option value="No">No</option></select></div>
        <div class="field"><label for="vandalised">Vandalised</label><select id="vandalised" name="vandalised"><option value="">— Select —</option><option value="Yes">Yes</option><option value="No">No</option></select></div>
        <div class="field"><label for="illegal">Illegal</label><select id="illegal" name="illegal"><option value="">— Select —</option><option value="Yes">Yes</option><option value="No">No</option></select></div>
        <div class="field"><label for="owner">Owner</label><select id="owner" name="owner"><option value="">— Select —</option><option value="Yes">Yes</option><option value="No">No</option></select></div>

        <div class="field"><label for="surname">Surname</label><input id="surname" name="surname" type="text"></div>
        <div class="field"><label for="name">Name</label><input id="name" name="name" type="text"></div>
        <div class="field"><label for="idNo">ID No</label><input id="idNo" name="idNo" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="e.g., 8501015000087"></div>
        <div class="field"><label for="phoneCode">Phone Code</label><input id="phoneCode" name="phoneCode" type="tel" inputmode="numeric" pattern="[0-9]*" placeholder="e.g., +27"></div>
        <div class="field"><label for="phoneNo">Phone No</label><input id="phoneNo" name="phoneNo" type="tel" inputmode="tel" placeholder="e.g., 821234567"></div>

        <div class="field"><label for="normalVendor">Normal Vendor</label><select id="normalVendor" name="normalVendor"><option value="">— Select —</option><option value="Yes">Yes</option><option value="No">No</option></select></div>
        <div class="field"><label for="recentVendor">Most Recent Vendor</label><input id="recentVendor" name="recentVendor" type="text"></div>
        <div class="field"><label for="meterNo">Meter No</label><input id="meterNo" name="meterNo" type="text"></div>
        <div class="field"><label for="split">Split</label><select id="split" name="split"><option value="">— Select —</option><option value="Yes">Yes</option><option value="No">No</option></select></div>
        <div class="field"><label for="commonBaseMeter">Common/Non Common Base Meter</label><input id="commonBaseMeter" name="commonBaseMeter" type="text"></div>
        <div class="field"><label for="edEcu">ED/ECU</label><input id="edEcu" name="edEcu" type="text"></div>
        <div class="field"><label for="meterType">Meter Type</label><input id="meterType" name="meterType" type="text"></div>
        <div class="field"><label for="tariffCode">Tariff Code</label><input id="tariffCode" name="tariffCode" type="text"></div>
        <div class="field"><label for="ampLimit">Amp Limit</label><input id="ampLimit" name="ampLimit" type="number" inputmode="numeric" pattern="[0-9]*"></div>
        <div class="field"><label for="supplyGroupCode">Supply Group Code</label><input id="supplyGroupCode" name="supplyGroupCode" type="text"></div>
        <div class="field"><label for="magCard">Mag Card/Keypad</label><input id="magCard" name="magCard" type="text"></div>
        <div class="field"><label for="stsOrProp">STS or Prop</label><input id="stsOrProp" name="stsOrProp" type="text"></div>

        <div class="field"><label for="tampered">Tampered</label><select id="tampered" name="tampered"><option value="">— Select —</option><option value="Yes">Yes</option><option value="No">No</option></select></div>
        <div class="field"><label for="tamperMethod">Tamper Method</label><input id="tamperMethod" name="tamperMethod" type="text"></div>
        <div class="field"><label for="removed">Removed</label><select id="removed" name="removed"><option value="">— Select —</option><option value="Yes">Yes</option><option value="No">No</option></select></div>
        <div class="field"><label for="tamperNotNo">Tamper Not No</label><input id="tamperNotNo" name="tamperNotNo" type="text"></div>

        <div class="field"><label for="cardTrip">Card Trip</label><select id="cardTrip" name="cardTrip"><option value="">— Select —</option><option value="Pass">Pass</option><option value="Fail">Fail</option></select></div>
        <div class="field"><label for="elTest">E/L Test</label><select id="elTest" name="elTest"><option value="">— Select —</option><option value="Pass">Pass</option><option value="Fail">Fail</option></select></div>
        <div class="field"><label for="meterFaulty">Meter Faulty</label><select id="meterFaulty" name="meterFaulty"><option value="">— Select —</option><option value="Yes">Yes</option><option value="No">No</option></select></div>
        <div class="field"><label for="replaced">Replaced</label><select id="replaced" name="replaced"><option value="">— Select —</option><option value="Yes">Yes</option><option value="No">No</option></select></div>
        <div class="field"><label for="mmfNo">MMF No</label><input id="mmfNo" name="mmfNo" type="text"></div>
        <div class="field"><label for="newMeterNo">New Meter No</label><input id="newMeterNo" name="newMeterNo" type="text"></div>
        <div class="field"><label for="newMeterType">New Meter Type</label><input id="newMeterType" name="newMeterType" type="text"></div>
        <div class="field"><label for="newMeterAmpLimit">New Meter Amp Limit</label><input id="newMeterAmpLimit" name="newMeterAmpLimit" type="number" inputmode="numeric" pattern="[0-9]*"></div>
        <div class="field"><label for="newMeterCardTrip">New Meter Card Trip</label><select id="newMeterCardTrip" name="newMeterCardTrip"><option value="">— Select —</option><option value="Pass">Pass</option><option value="Fail">Fail</option></select></div>
        <div class="field"><label for="newMeterElTest">New Meter E/L Test</label><select id="newMeterElTest" name="newMeterElTest"><option value="">— Select —</option><option value="Pass">Pass</option><option value="Fail">Fail</option></select></div>
        <div class="field"><label for="sealed">Sealed</label><select id="sealed" name="sealed"><option value="">— Select —</option><option value="Yes">Yes</option><option value="No">No</option></select></div>
        <div class="field"><label for="sealNo">Seal No</label><input id="sealNo" name="sealNo" type="text"></div>
        <div class="field"><label for="remarks">Remarks</label><textarea id="remarks" name="remarks"></textarea></div>

        <div class="actions">
            <button type="button" id="gpsBtn">Get GPS</button>
            <button type="button" id="viewDataBtn">View Data</button>
            <button type="button" id="pdfBtn">Download PDF</button>
            <button type="button" id="exportBtn">Download Excel</button>
            <button type="button" id="syncBtn">Sync Data (WIP)</button>
            <button type="button" id="cancelEditBtn" style="display: none;">Cancel Edit</button>
            <button type="submit" id="submitBtn">Save Data</button>
        </div>
    </form>

    <div id="message" role="alert" aria-live="polite"></div>

    <div id="savedDataSection">
        <h2>Saved Field Entries</h2>
        <div id="savedDataTableContainer">
            <table id="savedDataTable">
                <thead>
                    <tr id="savedTableHeader"></tr>
                </thead>
                <tbody id="savedTableBody"></tbody>
            </table>
        </div>
        <div id="savedDataActions">
            <button type="button" id="clearDataBtn">Clear All Saved Data</button>
            <button type="button" id="closeViewDataBtn">Close View</button>
        </div>
    </div>


    <script>
        const DB_NAME = 'FieldDataDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'records';

        let db;

        // --- DATABASE FUNCTIONS ---
        function initDb() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onupgradeneeded = e => e.target.result.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
                request.onsuccess = e => { db = e.target.result; resolve(db); };
                request.onerror = e => reject(e.target.error);
            });
        }

        function addRecord(record) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction(STORE_NAME, 'readwrite');
                tx.oncomplete = () => resolve();
                tx.onerror = e => reject(e.target.error);
                tx.objectStore(STORE_NAME).add(record);
            });
        }

        // [NEW] Update an existing record using its ID
        function updateRecord(record) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction(STORE_NAME, 'readwrite');
                tx.oncomplete = () => resolve();
                tx.onerror = e => reject(e.target.error);
                tx.objectStore(STORE_NAME).put(record); // put() handles updates
            });
        }

        function getAllRecords() {
            return new Promise((resolve, reject) => {
                const tx = db.transaction(STORE_NAME, 'readonly');
                const store = tx.objectStore(STORE_NAME);
                const request = store.getAll();
                request.onsuccess = e => resolve(e.target.result);
                request.onerror = e => reject(e.target.error);
            });
        }

        // [NEW] Get a single record by its ID
        function getRecordById(id) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction(STORE_NAME, 'readonly');
                const store = tx.objectStore(STORE_NAME);
                const request = store.get(id);
                request.onsuccess = e => resolve(e.target.result);
                request.onerror = e => reject(e.target.error);
            });
        }

        function clearAllRecords() {
             return new Promise((resolve, reject) => {
                const tx = db.transaction(STORE_NAME, 'readwrite');
                tx.oncomplete = () => resolve();
                tx.onerror = e => reject(e.target.error);
                tx.objectStore(STORE_NAME).clear();
            });
        }

        // --- UI & UTILITY FUNCTIONS ---
        const messageElement = document.getElementById('message');
        function showMessage(msg, type = 'info', duration = 3000) {
            messageElement.textContent = msg;
            messageElement.className = 'show';
            messageElement.style.backgroundColor = type === 'error' ? 'rgba(220, 53, 69, 0.8)' : type === 'success' ? 'rgba(40, 167, 69, 0.8)' : 'rgba(0, 0, 0, 0.7)';
            setTimeout(() => { messageElement.classList.remove('show'); }, duration);
        }

        function toDMS(dec, type) {
            const abs = Math.abs(dec);
            const deg = Math.floor(abs);
            const minF = (abs - deg) * 60;
            const min = Math.floor(minF);
            const sec = ((minF - min) * 60).toFixed(3);
            let hemisphere = type === 'latitude' ? (dec >= 0 ? 'N' : 'S') : (dec >= 0 ? 'E' : 'W');
            return `${String(deg).padStart(2, '0')} ${String(min).padStart(2, '0')} ${sec.padStart(6, '0')} ${hemisphere}`;
        }

        function setFieldRequired(fieldId, isRequired) {
            const field = document.getElementById(fieldId);
            const label = document.querySelector(`label[for="${fieldId}"]`);
            if (!field || !label) return;
            field.required = isRequired;
            let indicator = label.querySelector('.required-indicator');
            if (isRequired && !indicator) {
                indicator = document.createElement('span');
                indicator.className = 'required-indicator';
                indicator.textContent = ' *';
                indicator.style.color = 'red';
                label.appendChild(indicator);
            } else if (!isRequired && indicator) {
                label.removeChild(indicator);
            }
        }

        function updateMandatoryFields() {
            setFieldRequired('idNo', document.getElementById('owner').value === 'Yes');
            const tampered = document.getElementById('tampered').value === 'Yes';
            setFieldRequired('tamperMethod', tampered);
            setFieldRequired('removed', tampered);
            const faulty = document.getElementById('meterFaulty').value === 'No';
            setFieldRequired('cardTrip', faulty);
            setFieldRequired('elTest', faulty);
            const replaced = document.getElementById('replaced').value === 'Yes';
            setFieldRequired('mmfNo', replaced);
            setFieldRequired('newMeterNo', replaced);
            setFieldRequired('newMeterType', replaced);
            setFieldRequired('newMeterAmpLimit', replaced);
            const access = document.getElementById('access').value === 'Yes' && document.getElementById('atHome').value === 'Yes' && document.getElementById('connected').value === 'Yes';
            setFieldRequired('lat', access);
            setFieldRequired('lon', access);
            setFieldRequired('phoneNo', access);
            setFieldRequired('meterNo', access);
            setFieldRequired('edEcu', access);
        }

        // [NEW] Function to reset the form from edit mode to normal entry mode
        function resetFormToEntryMode() {
            document.getElementById('captureForm').reset();
            document.getElementById('editRecordId').value = '';
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.textContent = 'Save Data';
            submitBtn.style.backgroundColor = '#007bff';
            document.getElementById('cancelEditBtn').style.display = 'none';
            // Reset date to today and clear GPS
            const today = new Date();
            document.getElementById('date').value = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            document.getElementById('lat').value = '';
            document.getElementById('lon').value = '';
            updateMandatoryFields();
        }

        // --- PAGE LOAD & EVENT LISTENERS ---
        window.addEventListener('load', () => {
            // Login Logic
            const ACCESS_CODE = 'PWA2025', VERIFIED_KEY = 'userVerified';
            const loginOverlay = document.getElementById('loginOverlay');
            if (localStorage.getItem(VERIFIED_KEY) === 'true') {
                loginOverlay.style.display = 'none';
            } else {
                loginOverlay.style.display = 'flex';
                const loginBtn = document.getElementById('loginBtn');
                const accessCodeInput = document.getElementById('accessCode');
                const handleLogin = () => {
                    if (accessCodeInput.value === ACCESS_CODE) {
                        localStorage.setItem(VERIFIED_KEY, 'true');
                        loginOverlay.style.display = 'none';
                    } else {
                        document.getElementById('loginError').style.display = 'block';
                        accessCodeInput.value = '';
                        accessCodeInput.focus();
                    }
                };
                loginBtn.addEventListener('click', handleLogin);
                accessCodeInput.addEventListener('keyup', e => e.key === 'Enter' && handleLogin());
            }

            // Init DB, Service Worker, GPS, etc.
            initDb().catch(e => showMessage('Failed to initialize local database.', 'error'));
            if ('serviceWorker' in navigator) navigator.serviceWorker.register('service-worker.js');
            resetFormToEntryMode(); // Set initial form state

            // Attach listeners
            const controllerFields = ['owner', 'tampered', 'meterFaulty', 'replaced', 'access', 'atHome', 'connected'];
            controllerFields.forEach(id => document.getElementById(id).addEventListener('change', updateMandatoryFields));
        });

        /* --- FORM SUBMISSION (Add & Update) --- */
        document.getElementById('captureForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            const editId = document.getElementById('editRecordId').value;
            const formData = new FormData(this);
            const data = Object.fromEntries(formData.entries());
            delete data.editRecordId; // Remove hidden field from saved data

            // Format date correctly
            if (data.date) {
                const d = new Date(data.date);
                data.date = `${d.getFullYear()}/${String(d.getMonth() + 1).padStart(2, '0')}/${String(d.getDate()).padStart(2, '0')}`;
            }

            try {
                if (editId) { // UPDATE existing record
                    data.id = parseInt(editId, 10); // Ensure ID is a number and add it to the data object
                    await updateRecord(data);
                    showMessage('Record updated successfully ✔', 'success');
                } else { // ADD new record
                    await addRecord(data);
                    showMessage('Data saved successfully offline ✔', 'success');
                }
                resetFormToEntryMode();
                // If the data view is visible, refresh it
                if(document.getElementById('savedDataSection').classList.contains('visible')) {
                    document.getElementById('viewDataBtn').click(); // Close it
                    document.getElementById('viewDataBtn').click(); // Re-open it to refresh
                }
            } catch (error) {
                showMessage(`Failed to save data: ${error.message}`, 'error');
            }
        });

        /* --- EXPORT & DATA VIEW LOGIC --- */
        const formFieldOrder = ['workorderNo','zone','sector','cnc','contractorName','date','feederName','townshipName','transformerNo','standNo','installationNo','latitude','longitude','access','atHome','connected','abandoned','vandalised','illegal','owner','surname','name','idNo','phoneCode','phoneNo','normalVendor','recentVendor','meterNo','split','commonBaseMeter','edEcu','meterType','tariffCode','ampLimit','supplyGroupCode','magCard','stsOrProp','tampered','tamperMethod','removed','tamperNotNo','cardTrip','elTest','meterFaulty','replaced','mmfNo','newMeterNo','newMeterType','newMeterAmpLimit','newMeterCardTrip','newMeterElTest','sealed','sealNo','remarks'];
        const headerMap = {'workorderNo':'Workorder No','zone':'Zone','sector':'Sector','cnc':'CNC','contractorName':'Contractor Name','date':'Date','feederName':'Feeder Name','townshipName':'Township Name','transformerNo':'Transformer No','standNo':'Stand No','installationNo':'Installation No','latitude':'Latitude','longitude':'Longitude','access':'Access','atHome':'At Home','connected':'Connected','abandoned':'Abandoned','vandalised':'Vandalised','illegal':'Illegal','owner':'Owner','surname':'Surname','name':'Name','idNo':'ID No','phoneCode':'Phone Code','phoneNo':'Phone No','normalVendor':'Normal Vendor','recentVendor':'Most Recent Vendor','meterNo':'Meter No','split':'Split','commonBaseMeter':'Common/Non Common Base Meter','edEcu':'ED/ECU','meterType':'Meter Type','tariffCode':'Tariff Code','ampLimit':'Amp Limit','supplyGroupCode':'Supply Group Code','magCard':'Mag Card/Keypad','stsOrProp':'STS or Prop','tampered':'Tampered','tamperMethod':'Tamper Method','removed':'Removed','tamperNotNo':'Tamper Not No','cardTrip':'Card Trip','elTest':'E/L Test','meterFaulty':'Meter Faulty','replaced':'Replaced','mmfNo':'MMF No','newMeterNo':'New Meter No','newMeterType':'New Meter Type','newMeterAmpLimit':'New Meter Amp Limit','newMeterCardTrip':'New Meter Card Trip','newMeterElTest':'New Meter E/L Test','sealed':'Sealed','sealNo':'Seal No','remarks':'Remarks'};

        async function displayData() {
            try {
                const records = await getAllRecords();
                if (records.length === 0) {
                    showMessage('No saved data to display.', 'info');
                    document.getElementById('savedDataSection').classList.remove('visible');
                    return;
                }
                const allKeysInDb = new Set();
                records.forEach(r => Object.keys(r).forEach(k => k !== 'id' && allKeysInDb.add(k)));
                const headers = formFieldOrder.filter(key => allKeysInDb.has(key));
                allKeysInDb.forEach(key => !headers.includes(key) && headers.push(key));
                
                const tableHeader = document.getElementById('savedTableHeader');
                const tableBody = document.getElementById('savedTableBody');
                tableHeader.innerHTML = '';
                tableBody.innerHTML = '';

                headers.forEach(key => {
                    const th = document.createElement('th');
                    th.textContent = headerMap[key] || key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                    tableHeader.appendChild(th);
                });
                tableHeader.innerHTML += '<th>Edit</th>'; // Add header for the edit column

                records.forEach(record => {
                    const tr = document.createElement('tr');
                    headers.forEach(key => {
                        const td = document.createElement('td');
                        td.textContent = record[key] || '';
                        tr.appendChild(td);
                    });
                    // Add the edit button cell
                    const editTd = document.createElement('td');
                    editTd.innerHTML = `<button class="edit-btn" data-id="${record.id}">Edit</button>`;
                    tr.appendChild(editTd);
                    tableBody.appendChild(tr);
                });
                document.getElementById('savedDataSection').classList.add('visible');
            } catch (error) {
                showMessage('Failed to load saved data.', 'error');
            }
        }
        document.getElementById('viewDataBtn').addEventListener('click', () => {
            const section = document.getElementById('savedDataSection');
            if (section.classList.contains('visible')) {
                section.classList.remove('visible');
            } else {
                displayData();
            }
        });

        // [NEW] Event listener for edit buttons (using event delegation)
        document.getElementById('savedTableBody').addEventListener('click', async (e) => {
            if (e.target && e.target.classList.contains('edit-btn')) {
                const recordId = parseInt(e.target.dataset.id, 10);
                const record = await getRecordById(recordId);
                if (record) {
                    // Populate form
                    for (const key in record) {
                        if (document.getElementById(key)) {
                            document.getElementById(key).value = record[key];
                        }
                    }
                    // Handle date format which is stored as YYYY/MM/DD
                    if (record.date) {
                         document.getElementById('date').value = record.date.replace(/\//g, '-');
                    }
                    document.getElementById('editRecordId').value = record.id;
                    
                    // Update UI to "Edit Mode"
                    const submitBtn = document.getElementById('submitBtn');
                    submitBtn.textContent = 'Update Record';
                    submitBtn.style.backgroundColor = '#007bff';
                    document.getElementById('cancelEditBtn').style.display = 'inline-block';
                    document.getElementById('savedDataSection').classList.remove('visible');
                    updateMandatoryFields(); // Re-check required fields
                    window.scrollTo(0, 0); // Scroll to top of the page
                }
            }
        });
        
        document.getElementById('cancelEditBtn').addEventListener('click', resetFormToEntryMode);
        document.getElementById('closeViewDataBtn').addEventListener('click', () => document.getElementById('savedDataSection').classList.remove('visible'));
        document.getElementById('clearDataBtn').addEventListener('click', async () => {
            if (confirm('Are you sure you want to clear ALL saved data? This cannot be undone.')) {
                await clearAllRecords();
                displayData(); // Refresh view
                showMessage('All saved data cleared successfully!', 'success');
            }
        });
        
        // Other button listeners (PDF, Excel, etc.)
        document.getElementById('pdfBtn').addEventListener('click', async () => {
            const { jsPDF } = window.jspdf;
            const records = await getAllRecords();
            if (records.length === 0) return showMessage('No data to export.', 'info');

            const doc = new jsPDF({ orientation: 'landscape' });
            const allKeysInDb = new Set();
            records.forEach(r => Object.keys(r).forEach(k => k !== 'id' && allKeysInDb.add(k)));
            const orderedKeys = formFieldOrder.filter(key => allKeysInDb.has(key));
            allKeysInDb.forEach(key => !orderedKeys.includes(key) && orderedKeys.push(key));
            const tableHeaders = orderedKeys.map(key => headerMap[key] || key);
            const tableBody = records.map(record => orderedKeys.map(key => record[key] || ''));

            doc.text("Field Data Report", 14, 15);
            doc.autoTable({ head: [tableHeaders], body: tableBody, startY: 20, theme: 'grid', styles: { fontSize: 7, cellPadding: 1.5 }, headStyles: { fillColor: [41, 128, 185], fontSize: 7.5 }});
            doc.save('Field_Data_Report.pdf');
        });
        document.getElementById('exportBtn').addEventListener('click', async () => {
            const records = await getAllRecords();
            if (records.length === 0) return showMessage('No data to export.', 'info');
            const formatted = records.map(rec => { const obj = {}; for (const k in rec) { if (k !== 'id') obj[headerMap[k] || k] = rec[k]; } return obj; });
            const ws = XLSX.utils.json_to_sheet(formatted, { header: formFieldOrder.map(k => headerMap[k]) });
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'FieldData');
            XLSX.writeFile(wb, 'Field_Data.xlsx');
        });
        document.getElementById('syncBtn').addEventListener('click', () => showMessage('Sync functionality is under development.', 'info'));
        document.getElementById('gpsBtn').onclick = () => {
            if (!navigator.geolocation) return showMessage('Geolocation not supported.', 'error');
            navigator.geolocation.getCurrentPosition(
                pos => {
                    document.getElementById('lat').value = toDMS(pos.coords.latitude, 'latitude');
                    document.getElementById('lon').value = toDMS(pos.coords.longitude, 'longitude');
                },
                err => showMessage(`GPS Error: ${err.message}`, 'error'),
                { enableHighAccuracy: true }
            );
        };
    </script>
</body>
</html>
